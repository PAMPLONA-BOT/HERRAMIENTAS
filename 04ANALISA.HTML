<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador Profesional de Consumo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #2980b9;
            --light-gray: #ecf0f1;
            --medium-gray: #bdc3c7;
            --dark-gray: #7f8c8d;
            --zero-color: #7f8c8d;
            --urgent-color: #8e44ad;
            --na-color: #95a5a6;
            --possible-new-color: #1abc9c; /* Teal for new meters */
            --cyclometer-reset-color: #d35400; /* Pumpkin orange for cyclometer reset */
            --possible-error-color: #c0392b; /* Strong red for >700% error */
            --background-color: #f4f6f9;
            --panel-bg: #ffffff;
            --header-bg: #ffffff;
            --border-color: #dee2e6;
        }
        
        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            line-height: 1.6;
            color: var(--primary-color);
            background-color: var(--background-color);
        }

        header {
            background-color: var(--header-bg);
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        header h1 {
            margin: 0;
            font-size: 1.6rem;
            font-weight: 600;
        }

        header h1 i {
            color: var(--secondary-color);
            margin-right: 0.75rem;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        h1, h2, h3, h4 {
            color: var(--primary-color);
        }
        
        #dashboard {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 20px;
            align-items: start;
            margin-top: 20px;
        }

        .main-data-panel {
            grid-column: 1 / -1;
        }

        .panel {
            background-color: var(--panel-bg);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }

        #upload-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .upload-area {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        #fileName {
            color: var(--dark-gray);
            font-style: italic;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--primary-color);
            color: white;
            position: sticky;
            top: 0;
            font-weight: 500;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-normal { background-color: var(--success-color); }
        .status-above { background-color: var(--success-color); }
        .status-below { background-color: var(--danger-color); }
        .status-alert-high { background-color: var(--warning-color); }
        .status-alert-low { background-color: var(--warning-color); }
        .status-urgent-high { background-color: var(--urgent-color); }
        .status-urgent-low { background-color: var(--urgent-color); }
        .status-error { background-color: var(--danger-color); }
        .status-posible-nuevo-medidor { background-color: var(--possible-new-color); }
        .status-reinicio-ciclometrico { background-color: var(--cyclometer-reset-color); }
        .status-posible-error-alto-consumo { background-color: var(--possible-error-color); }
        .status-consumo-cero { background-color: var(--zero-color); }
        .status-sin-lecturas { background-color: var(--na-color); }
        
        .btn {
            padding: 0.6rem 1.2rem;
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary { background-color: var(--secondary-color); color: white; border-color: var(--secondary-color); }
        .btn-primary:hover:not(:disabled) { background-color: #2980b9; border-color: #2980b9; }
        .btn-success { background-color: var(--success-color); color: white; border-color: var(--success-color); }
        .btn-success:hover:not(:disabled) { background-color: #229954; border-color: #229954;}

        .btn-outline-danger { background-color: transparent; color: var(--danger-color); border-color: var(--danger-color); }
        .btn-outline-danger:hover { background-color: var(--danger-color); color: white; }
        
        .btn-outline-secondary { background-color: transparent; color: var(--dark-gray); border-color: var(--medium-gray); }
        .btn-outline-secondary:hover { background-color: var(--dark-gray); color: white; border-color: var(--dark-gray);}

        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-warning { background-color: var(--warning-color); color: white; }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .card {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            text-align: center;
        }
        
        .card h3 {
            margin-top: 0;
            font-size: 0.8em;
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .card .value {
            font-size: 1.4em;
            font-weight: 600;
            margin: 2px 0 4px 0;
        }
        
        .card-description {
            font-size: 0.7em;
            color: #7f8c8d;
            line-height: 1.2;
        }

        .chart-container {
            margin: 30px 0;
        }
        
        .tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .tab-btn { padding: 12px 25px; background: none; border: none; cursor: pointer; font-weight: 500; color: var(--dark-gray); position: relative; transition: all 0.3s; }
        .tab-btn.active { color: var(--secondary-color); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 3px; background-color: var(--secondary-color); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .form-control { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 0; }
        .client-details { background-color: var(--panel-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 20px; }
        .consumption-timeline { position: relative; padding-left: 30px; margin: 20px 0; }
        .consumption-timeline::before { content: ''; position: absolute; left: 10px; top: 0; bottom: 0; width: 2px; background-color: var(--secondary-color); }
        .timeline-item { position: relative; margin-bottom: 20px; }
        .timeline-item::before { content: ''; position: absolute; left: -30px; top: 5px; width: 12px; height: 12px; border-radius: 50%; background-color: var(--secondary-color); border: 2px solid white; }
        
        .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 0.8em; font-weight: 600; margin-left: 8px; }
        .badge-success { background-color: var(--success-color); color: white; }
        .badge-danger { background-color: var(--danger-color); color: white; }
        .badge-warning { background-color: var(--warning-color); color: white; }
        .badge-info { background-color: var(--info-color); color: white; }
        .badge-posible-nuevo-medidor { background-color: var(--possible-new-color); color: white; }
        .badge-reinicio-ciclometrico { background-color: var(--cyclometer-reset-color); color: white; }
        .badge-posible-error-alto-consumo { background-color: var(--possible-error-color); color: white; }
        .badge-consumo-cero { background-color: var(--zero-color); color: white; }
        .badge-urgent { background-color: var(--urgent-color); color: white; }
        .badge-sin-lecturas { background-color: var(--na-color); color: white; }
        
        .filter-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .filter-tag { background-color: var(--light-gray); padding: 5px 10px; border-radius: 15px; font-size: 0.8em; display: flex; align-items: center; }
        .filter-tag button { background: none; border: none; margin-left: 5px; cursor: pointer; color: var(--primary-color); }
        
        .filter-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0 20px; }
        .filter-section { margin-bottom: 15px; }
        .filter-section.full-width { grid-column: 1 / -1; }
        .filter-section label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9em; }
        
        @media (max-width: 1200px) { #dashboard { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { #upload-panel { flex-direction: column; align-items: stretch; } .action-buttons { justify-content: flex-start; } }
        @media (max-width: 500px) { .filter-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header>
        <div class="container">
             <h1><i class="fas fa-chart-line"></i> Analizador Profesional de Consumo</h1>
        </div>
    </header>

    <div class="container">
        <div class="panel" id="upload-panel">
            <div class="upload-area">
                <label for="excelFile" class="btn btn-primary">
                    <i class="fas fa-folder-open"></i> Seleccionar Archivo
                </label>
                <input type="file" id="excelFile" accept=".xlsx, .xls" style="display: none;">
                <span id="fileName">Ningún archivo seleccionado</span>
            </div>
            <div class="action-buttons">
                <button class="btn btn-success" onclick="processExcel()" id="analyzeBtn" disabled>
                    <i class="fas fa-chart-bar"></i> Analizar Datos
                </button>
                <button class="btn btn-outline-danger" onclick="clearResults()">
                    <i class="fas fa-trash-alt"></i> Limpiar Todo
                </button>
                <button class="btn btn-outline-secondary" onclick="showAllZeroAndNA()">
                    <i class="fas fa-filter"></i> Mostrar Casos Especiales
                </button>
            </div>
        </div>
        
        <div id="dashboard" style="display: none;">
            <div class="panel">
                <h3><i class="fas fa-filter"></i> Filtros</h3>
                <div id="activeFilters" class="filter-tags"></div>
                <div class="filter-grid">
                    <div class="filter-section full-width">
                        <label for="filterStatus">Estado de consumo:</label>
                        <select id="filterStatus" class="form-control" onchange="applyFilters()">
                            <option value="all">Todos los registros</option>
                            <option value="posible-error-alto-consumo">POSIBLE ERROR (+700%)</option>
                            <option value="urgent-high">Urgente alto (+100%)</option>
                            <option value="urgent-low">Urgente bajo (-100%)</option>
                            <option value="alert-high">Alertas altas (+40%)</option>
                            <option value="alert-low">Alertas bajas (-40%)</option>
                            <option value="above">Sobre promedio</option>
                            <option value="below">Bajo promedio</option>
                            <option value="reinicio-ciclometrico">REINICIO DE CICLOMETRICO</option>
                            <option value="posible-nuevo-medidor">Posible Medidor/Cuenta Nueva</option>
                            <option value="error">Errores en datos</option>
                            <option value="consumo-cero">Consumo Cero (Total)</option>
                            <option value="sin-lecturas">Sin Lecturas (Total)</option>
                        </select>
                    </div>
                    <div class="filter-section full-width"><label for="filterClient">Buscar por ID de cliente:</label><input type="text" id="filterClient" class="form-control" placeholder="Ingrese ID de cliente" onkeyup="applyFilters()"></div>
                    <div class="filter-section"><label for="filterServicio">Tipo de Servicio:</label><select id="filterServicio" class="form-control" onchange="applyFilters()"><option value="all">Todos</option></select></div>
                    <div class="filter-section"><label for="filterUbicacion">Ubicación:</label><select id="filterUbicacion" class="form-control" onchange="applyFilters()"><option value="all">Todos</option></select></div>
                    <div class="filter-section"><label for="filterSeccion">Sección:</label><select id="filterSeccion" class="form-control" onchange="applyFilters()"><option value="all">Todos</option></select></div>
                    <div class="filter-section"><label for="filterIntentos">Intentos:</label><select id="filterIntentos" class="form-control" onchange="applyFilters()"><option value="all">Todos</option></select></div>
                    <div class="filter-section"><label for="filterOperario">Nombre Operario:</label><select id="filterOperario" class="form-control" onchange="applyFilters()"><option value="all">Todos</option></select></div>
                    <div class="filter-section"><label for="filterEstadoOSB">Estado OSB:</label><select id="filterEstadoOSB" class="form-control" onchange="applyFilters()"><option value="all">Todos</option></select></div>
                    <div class="filter-section"><label for="filterCodCausaObs">CODCAUSAOBS:</label><select id="filterCodCausaObs" class="form-control" onchange="applyFilters()"><option value="all">Todos</option></select></div>
                    <div class="filter-section"><label for="filterObsTexto">OBS_TEXTO:</label><select id="filterObsTexto" class="form-control" onchange="applyFilters()"><option value="all">Todos</option></select></div>
                    <div class="filter-section" style="display: none;"><label for="filterObsPredio">OBS_PREDIO:</label><select id="filterObsPredio" class="form-control" onchange="applyFilters()"><option value="all">Todos</option></select></div>
                </div>
            </div>
            <div class="panel">
                <h3><i class="fas fa-chart-pie"></i> Resumen (Filtrado)</h3>
                <div id="summaryCards" class="summary-cards"></div>
                <div style="margin-top: 25px;">
                    <h3><i class="fas fa-download"></i> Exportar Reporte</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="btn btn-success" onclick="exportToExcel()" style="width: 100%;"><i class="fas fa-file-excel"></i> Exportar a Excel</button>
                        <button class="btn btn-danger" onclick="exportToPDF()" style="width: 100%;"><i class="fas fa-file-pdf"></i> Exportar a PDF</button>
                        <button class="btn btn-warning" onclick="exportCharts()" style="width: 100%;"><i class="fas fa-image"></i> Exportar Gráficos</button>
                    </div>
                </div>
            </div>
            <div class="panel main-data-panel">
                <div class="tabs">
                    <button class="tab-btn active" onclick="openTab(event, 'tabTable')"><i class="fas fa-table"></i> Tabla de Datos</button>
                    <button class="tab-btn" onclick="openTab(event, 'tabCharts')"><i class="fas fa-chart-bar"></i> Visualización</button>
                    <button class="tab-btn" onclick="openTab(event, 'tabAnalysis')"><i class="fas fa-chart-line"></i> Análisis Detallado</button>
                </div>
                <div id="tabTable" class="tab-content active"><div id="resultsTable" style="max-height: 600px; overflow-y: auto;"></div></div>
                <div id="tabCharts" class="tab-content">
                    <div class="chart-container"><h3>Distribución de Variaciones</h3><canvas id="chartDistribution" height="300"></canvas></div>
                    <div class="chart-container"><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;"><div><h3>Top 5 Mayores Variaciones</h3><canvas id="chartTopAbove" height="250"></canvas></div><div><h3>Top 5 Menores Variaciones</h3><canvas id="chartTopBelow" height="250"></canvas></div></div></div>
                    <div class="chart-container"><h3>Consumo por Período (Clientes Seleccionados)</h3><canvas id="chartMonthlyConsumption" height="300"></canvas></div>
                </div>
                <div id="tabAnalysis" class="tab-content"><div id="detailedAnalysis"></div></div>
            </div>
        </div>
    </div>
    
    <script>
        let analysisData = [];
        let currentCharts = [];
        let filteredData = [];
        
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const fileName = e.target.files[0] ? e.target.files[0].name : 'Ningún archivo seleccionado';
            document.getElementById('fileName').textContent = fileName;
            document.getElementById('analyzeBtn').disabled = !e.target.files[0];
        });
        
        function processExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            if (!file) { alert('Por favor seleccione un archivo Excel'); return; }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    analyzeData(jsonData);
                    document.getElementById('dashboard').style.display = 'grid';
                } catch (error) {
                    alert('Error al procesar el archivo. Asegúrese de que es un Excel válido con la estructura correcta.');
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function analyzeData(data) {
            analysisData = [];
            currentCharts = [];
            filteredData = [];
            
            let headerRow = 0;
            for (let i = 0; i < data.length; i++) {
                if (data[i][0] && data[i][0].toString().trim().toUpperCase() === 'CLIENTESTIPO') {
                    headerRow = i; break;
                }
            }
            
            const headers = data[headerRow].map(h => h.toString().trim());
            const dataRows = data.slice(headerRow + 1).filter(row => row[0]);
            
            const consumoStartIndex = headers.indexOf('J_ANTERIOR6');
            const consumoEndIndex = headers.indexOf('J_ACTUAL');
            
            for (const row of dataRows) {
                const cliente = row[0].toString();
                
                const values = row.slice(consumoStartIndex, consumoEndIndex + 1).map(v => {
                    if (v === "N/A" || v === "NA" || v === "" || v === null || v === undefined) return "N/A";
                    const num = parseFloat(v);
                    return isNaN(num) ? "N/A" : num;
                });
                
                const servicio = row[headers.indexOf('SERVICIO')] || '';
                const ubicacion = row[headers.indexOf('UBICACION')] || '';
                const seccion = row[headers.indexOf('SECCION')] || '';
                const intentos = row[headers.indexOf('INTENTOS')] || '';
                const nombreOperario = row[headers.indexOf('NOMBRE_OPERARIO')] || '';
                const estadoOSB = row[headers.indexOf('ESTADO_OSB')] || '';
                const codCausaObs = row[headers.indexOf('CODCAUSAOBS')] || '';
                const obsPredio = row[headers.indexOf('OBS_PREDIO')] || '';
                const obsTexto = row[headers.indexOf('OBS_TEXTO')] || '';
                
                const allNA = values.every(v => v === "N/A");
                const validValues = values.filter(v => typeof v === 'number'); 
                
                let dataValid = true;
                let validationMessage = "Datos válidos";
                let errorDetails = "";
                let isPossibleNewMeter = false;
                let isCyclometerReset = false;

                // --- LÓGICA DE VALIDACIÓN MEJORADA (ORDEN DE PRIORIDAD) ---
                
                // 1. REINICIO DE CICLOMETRICO (la más específica)
                if (validValues.length > 1) {
                    let resetIndex = -1;
                    for (let i = 1; i < validValues.length; i++) {
                        if (validValues[i-1] > 90000 && validValues[i] < 800) {
                            resetIndex = i;
                            break;
                        }
                    }
                    if (resetIndex !== -1) {
                        let subsequentReadingsOk = true;
                        for (let i = resetIndex + 1; i < validValues.length; i++) {
                            if (validValues[i] < validValues[i-1]) { subsequentReadingsOk = false; break; }
                        }
                        if (subsequentReadingsOk) {
                            isCyclometerReset = true;
                            validationMessage = `REINICIO DE CICLOMETRICO: Lectura pasó de ${validValues[resetIndex-1]} a ${validValues[resetIndex]} kWh.`;
                        }
                    }
                }
                
                // 2. Caída de lectura (cambio de medidor) - si no es reinicio
                if (!isCyclometerReset && validValues.length > 1) {
                    let resetIndex = -1;
                    for (let i = 1; i < validValues.length; i++) {
                        if (validValues[i] < validValues[i-1] && validValues[i] < 800) {
                            resetIndex = i;
                            break;
                        }
                    }
                    if (resetIndex !== -1) {
                        let subsequentReadingsOk = true;
                        for (let i = resetIndex + 1; i < validValues.length; i++) {
                            if (validValues[i] < validValues[i-1]) { subsequentReadingsOk = false; break; }
                        }
                        if (subsequentReadingsOk) {
                            isPossibleNewMeter = true;
                            validationMessage = `Caída de lectura detectada (a ${validValues[resetIndex]} kWh), seguida por lecturas crecientes. Posible cambio de medidor.`;
                        }
                    }
                }
                
                // 3. Cuenta nueva - si no es ninguna de las anteriores
                if (!isCyclometerReset && !isPossibleNewMeter) {
                    const firstValidReadingIndex = values.findIndex(v => typeof v === 'number');
                    if (firstValidReadingIndex > 0 && validValues.length > 0 && validValues[0] < 800) {
                        let tailIsIncreasing = true;
                        if (validValues.length > 1) {
                            for (let i = 1; i < validValues.length; i++) {
                                if (validValues[i] < validValues[i-1]) { tailIsIncreasing = false; break; }
                            }
                        }
                        if (tailIsIncreasing) {
                            isPossibleNewMeter = true;
                            validationMessage = `Historial inicial no disponible y lectura inicial baja (${validValues[0]} kWh). Posible cuenta nueva.`;
                        }
                    }
                }

                // 4. Si no es un caso especial, validar errores de secuencia
                if (!isPossibleNewMeter && !isCyclometerReset && validValues.length > 1) {
                    for (let i = 1; i < validValues.length; i++) {
                        if (validValues[i] < validValues[i-1]) {
                            dataValid = false;
                            errorDetails += `Lectura en período ${i+1} (${validValues[i]}) es menor que la anterior (${validValues[i-1]}). `;
                        }
                    }
                    if (!dataValid) validationMessage = 'Datos no consecutivos';
                }
                
                let monthlyDifferences = [];
                if (validValues.length > 1) {
                    if (isCyclometerReset || isPossibleNewMeter) {
                        let startIndexForDiffs = -1;
                        for(let i = 1; i < validValues.length; i++){
                            if(validValues[i] < validValues[i-1]){
                                startIndexForDiffs = i;
                                break;
                            }
                        }
                        if (startIndexForDiffs === -1 && isPossibleNewMeter) {
                           for (let i = 1; i < validValues.length; i++) {
                               monthlyDifferences.push(validValues[i] - validValues[i-1]);
                           }
                        } else if (startIndexForDiffs !== -1) {
                           for (let i = startIndexForDiffs; i < validValues.length; i++) {
                               monthlyDifferences.push(validValues[i] - validValues[i-1]);
                           }
                        }
                    } else if (dataValid) {
                        for (let i = 1; i < validValues.length; i++) {
                            monthlyDifferences.push(validValues[i] - validValues[i-1]);
                        }
                    }
                }

                const allZeroReadings = validValues.length > 0 && validValues.every(v => v === 0);
                const allDifferencesZero = monthlyDifferences.length > 0 && monthlyDifferences.every(d => d === 0);

                let status = 'normal', priority = 'normal';
                
                if (allNA) {
                    status = 'sin-lecturas'; priority = 'high'; validationMessage = 'Todos los períodos sin lectura (N/A)';
                } else if (allZeroReadings || allDifferencesZero) {
                    status = 'consumo-cero'; priority = 'urgent';
                    validationMessage = allZeroReadings ? 'Todos los períodos tienen lectura cero.' : 'El consumo entre períodos es cero.';
                } else if (isCyclometerReset) {
                    status = 'reinicio-ciclometrico'; priority = 'high';
                } else if (isPossibleNewMeter) {
                    status = 'posible-nuevo-medidor'; priority = 'high';
                } else if (validValues.length < 2) {
                    status = 'error'; priority = 'high'; validationMessage = 'Datos insuficientes para análisis.';
                } else if (!dataValid) {
                    status = 'error'; priority = 'high';
                } else {
                    if (monthlyDifferences.length > 0) {
                        const avgDifference = monthlyDifferences.reduce((sum, val) => sum + val, 0) / monthlyDifferences.length;
                        const lastDiff = monthlyDifferences[monthlyDifferences.length-1];
                        const diffVsAvg = lastDiff - avgDifference;
                        const percentageVsAvg = (avgDifference > 0) ? (diffVsAvg / avgDifference) * 100 : (diffVsAvg > 0 ? Infinity : -Infinity);
                        
                        if (percentageVsAvg >= 700) { status = 'posible-error-alto-consumo'; priority = 'urgent'; }
                        else if (percentageVsAvg >= 100) { status = 'urgent-high'; priority = 'urgent'; }
                        else if (percentageVsAvg <= -100) { status = 'urgent-low'; priority = 'urgent'; }
                        else if (percentageVsAvg >= 40) { status = 'alert-high'; priority = 'high'; }
                        else if (percentageVsAvg <= -40) { status = 'alert-low'; priority = 'high'; }
                        else if (diffVsAvg >= 0) { // CORRECTED: Includes exactly 0 difference
                            status = 'above';
                        }
                        else if (diffVsAvg < 0) { 
                            status = 'below'; 
                        }
                    } else {
                        status = 'error'; priority = 'high'; validationMessage = 'No hay suficientes datos para calcular variación.';
                    }
                }

                let monthlyDetails = '<div class="consumption-timeline">';
                if (validValues.length > 1 && (dataValid || isPossibleNewMeter || isCyclometerReset)) {
                    for (let i = 1; i < validValues.length; i++) {
                        const diff = validValues[i] - validValues[i-1];
                        const percentage = validValues[i-1] === 0 ? (diff > 0 ? Infinity : 0) : (diff / Math.abs(validValues[i-1])) * 100;
                        monthlyDetails += `<div class="timeline-item"><strong>Variación ${i}:</strong> ${validValues[i-1]} kWh → ${validValues[i]} kWh <span class="badge ${diff >= 0 ? 'badge-success' : 'badge-danger'}">${diff >= 0 ? '+' : ''}${diff.toFixed(2)} kWh (${percentage === Infinity ? '∞' : (percentage >= 0 ? '+' : '') + percentage.toFixed(2)}%)</span></div>`;
                    }
                }
                monthlyDetails += '</div>';
                
                const clientData = {
                    cliente, servicio, ubicacion, seccion, intentos, nombreOperario, estadoOSB, codCausaObs, obsPredio, obsTexto,
                    status, priority, monthlyDifferences, monthlyDetails, values, validValues,
                    headers: headers.slice(consumoStartIndex, consumoEndIndex + 1), validationMessage, errorDetails
                };
                
                if (!['sin-lecturas', 'consumo-cero', 'error', 'posible-nuevo-medidor', 'reinicio-ciclometrico'].includes(status) && monthlyDifferences.length > 0) {
                    clientData.avgDifference = monthlyDifferences.reduce((sum, val) => sum + val, 0) / monthlyDifferences.length;
                    clientData.lastDiff = monthlyDifferences[monthlyDifferences.length-1];
                    clientData.diffVsAvg = clientData.lastDiff - clientData.avgDifference;
                    clientData.percentageVsAvg = (clientData.avgDifference > 0) ? (clientData.diffVsAvg / clientData.avgDifference) * 100 : (clientData.diffVsAvg > 0 ? Infinity : -Infinity);
                }
                
                analysisData.push(clientData);
            }
            
            applyFilters();
        }
        
        // --- NEW FUNCTION for cascading filters ---
        function updateDynamicFilterOptions(dataForOptions) {
            const filterIds = {
                servicio: 'filterServicio', ubicacion: 'filterUbicacion', seccion: 'filterSeccion',
                intentos: 'filterIntentos', operario: 'filterOperario', estadoOSB: 'filterEstadoOSB',
                codCausaObs: 'filterCodCausaObs', obsTexto: 'filterObsTexto'
            };
            const dataKeys = {
                servicio: 'servicio', ubicacion: 'ubicacion', seccion: 'seccion',
                intentos: 'intentos', operario: 'nombreOperario', estadoOSB: 'estadoOSB',
                codCausaObs: 'codCausaObs', obsTexto: 'obsTexto'
            };

            // Store current selections
            const currentSelections = {};
            for (const key in filterIds) {
                currentSelections[key] = document.getElementById(filterIds[key]).value;
            }

            // Get new unique values from the currently filtered data
            const dynamicUniqueValues = {};
            for (const key in filterIds) {
                dynamicUniqueValues[key] = new Set();
            }

            dataForOptions.forEach(item => {
                for (const key in dataKeys) {
                    if (item[dataKeys[key]]) {
                        dynamicUniqueValues[key].add(item[dataKeys[key]]);
                    }
                }
            });
            
            // Rebuild dropdowns
            for (const key in filterIds) {
                const select = document.getElementById(filterIds[key]);
                select.innerHTML = '<option value="all">Todos</option>';
                [...dynamicUniqueValues[key]].sort().forEach(value => {
                    select.innerHTML += `<option value="${value}">${value}</option>`;
                });
            }

            // Restore previous selections
            for (const key in filterIds) {
                document.getElementById(filterIds[key]).value = currentSelections[key];
            }
        }

        function updateTable() {
            let tableHTML = `<table id="dataTable"><thead><tr><th>CLIENTE</th><th>SECCIÓN</th><th>ESTADO</th><th>PRIORIDAD</th><th>PROMEDIO (kWh)</th><th>ÚLTIMA VARIACIÓN (kWh)</th><th>DIFERENCIA (kWh)</th><th>% VS PROMEDIO</th><th>ACCIONES</th></tr></thead><tbody>`;
            filteredData.forEach(item => {
                let statusBadge, priorityBadge;
                switch(item.status) {
                    case 'error': statusBadge = `<span class="status-badge" style="background-color: rgba(231, 76, 60, 0.1); color: #e74c3c;"><span class="status-indicator status-error"></span>Error</span>`; priorityBadge = '<span class="badge badge-danger">Alta</span>'; break;
                    case 'posible-nuevo-medidor': statusBadge = `<span class="status-badge" style="background-color: rgba(26, 188, 156, 0.1); color: var(--possible-new-color);"><span class="status-indicator status-posible-nuevo-medidor"></span>Nuevo Medidor</span>`; priorityBadge = '<span class="badge badge-warning">Alta</span>'; break;
                    case 'reinicio-ciclometrico': statusBadge = `<span class="status-badge" style="background-color: rgba(211, 84, 0, 0.1); color: var(--cyclometer-reset-color);"><span class="status-indicator status-reinicio-ciclometrico"></span>Reinicio Cicl.</span>`; priorityBadge = '<span class="badge badge-warning">Alta</span>'; break;
                    case 'posible-error-alto-consumo': statusBadge = `<span class="status-badge" style="background-color: rgba(192, 57, 43, 0.1); color: var(--possible-error-color);"><span class="status-indicator status-posible-error-alto-consumo"></span>Posible Error</span>`; priorityBadge = '<span class="badge badge-urgent">Urgente</span>'; break;
                    case 'consumo-cero': statusBadge = `<span class="status-badge" style="background-color: rgba(127, 140, 141, 0.1); color: #7f8c8d;"><span class="status-indicator status-consumo-cero"></span>Consumo Cero</span>`; priorityBadge = '<span class="badge badge-urgent">Urgente</span>'; break;
                    case 'sin-lecturas': statusBadge = `<span class="status-badge" style="background-color: rgba(149, 165, 166, 0.1); color: #95a5a6;"><span class="status-indicator status-sin-lecturas"></span>Sin Lecturas</span>`; priorityBadge = '<span class="badge badge-sin-lecturas">Alta</span>'; break;
                    case 'urgent-high': statusBadge = `<span class="status-badge" style="background-color: rgba(142, 68, 173, 0.1); color: #8e44ad;"><span class="status-indicator status-urgent-high"></span>Urgente Alto</span>`; priorityBadge = '<span class="badge badge-urgent">Urgente</span>'; break;
                    case 'urgent-low': statusBadge = `<span class="status-badge" style="background-color: rgba(142, 68, 173, 0.1); color: #8e44ad;"><span class="status-indicator status-urgent-low"></span>Urgente Bajo</span>`; priorityBadge = '<span class="badge badge-urgent">Urgente</span>'; break;
                    case 'alert-high': statusBadge = `<span class="status-badge" style="background-color: rgba(243, 156, 18, 0.1); color: #f39c12;"><span class="status-indicator status-alert-high"></span>Alerta Alta</span>`; priorityBadge = '<span class="badge badge-warning">Alta</span>'; break;
                    case 'alert-low': statusBadge = `<span class="status-badge" style="background-color: rgba(243, 156, 18, 0.1); color: #f39c12;"><span class="status-indicator status-alert-low"></span>Alerta Baja</span>`; priorityBadge = '<span class="badge badge-warning">Alta</span>'; break;
                    case 'above': statusBadge = `<span class="status-badge" style="background-color: rgba(39, 174, 96, 0.1); color: #27ae60;"><span class="status-indicator status-above"></span>Sobre</span>`; priorityBadge = '<span class="badge badge-info">Normal</span>'; break;
                    case 'below': statusBadge = `<span class="status-badge" style="background-color: rgba(231, 76, 60, 0.1); color: #e74c3c;"><span class="status-indicator status-below"></span>Bajo</span>`; priorityBadge = '<span class="badge badge-info">Normal</span>'; break;
                    default: statusBadge = `<span class="status-badge" style="background-color: rgba(52, 152, 219, 0.1); color: #3498db;"><span class="status-indicator status-normal"></span>Normal</span>`; priorityBadge = '<span class="badge badge-info">Normal</span>';
                }
                const avgDiff = item.avgDifference !== undefined ? item.avgDifference.toFixed(2) : 'N/A';
                const lastDiff = item.lastDiff !== undefined ? (item.lastDiff >= 0 ? '+' : '') + item.lastDiff.toFixed(2) : 'N/A';
                const diffVsAvg = item.diffVsAvg !== undefined ? (item.diffVsAvg >= 0 ? '+' : '') + item.diffVsAvg.toFixed(2) : 'N/A';
                const percentageVsAvg = item.percentageVsAvg !== undefined ? (item.percentageVsAvg === Infinity ? '∞' : (item.percentageVsAvg >= 0 ? '+' : '') + item.percentageVsAvg.toFixed(2) + '%') : 'N/A';
                tableHTML += `<tr style="${item.priority === 'urgent' ? 'background-color: rgba(142, 68, 173, 0.05);' : item.priority === 'high' ? 'background-color: rgba(243, 156, 18, 0.05);' : ''}"><td>${item.cliente}</td><td>${item.seccion}</td><td>${statusBadge}</td><td>${priorityBadge}</td><td>${avgDiff}</td><td>${lastDiff}</td><td>${diffVsAvg}</td><td>${percentageVsAvg}</td><td><button class="btn btn-primary" onclick="showClientDetails('${item.cliente}')" style="padding: 5px 10px; font-size: 0.8em;"><i class="fas fa-search"></i> Detalles</button></td></tr>`;
            });
            tableHTML += '</tbody></table>';
            document.getElementById('resultsTable').innerHTML = tableHTML;
        }
        
        function updateSummaryCards(total, above, below, alertHigh, alertLow, urgentHigh, urgentLow, error, newMeter, zero, na, cyclometerReset, possibleError) {
            const cardsHTML = `
                <div class="card"><h3>Total Clientes</h3><div class="value">${total}</div><div class="card-description">Analizados</div></div>
                <div class="card"><h3>Posible Error</h3><div class="value" style="color: var(--possible-error-color);">${possibleError}</div><div class="card-description">Consumo > 700%</div></div>
                <div class="card"><h3>Urgente Alto</h3><div class="value" style="color: var(--urgent-color);">${urgentHigh}</div><div class="card-description">100% a 700%</div></div>
                <div class="card"><h3>Urgente Bajo</h3><div class="value" style="color: var(--urgent-color);">${urgentLow}</div><div class="card-description">Var. < -100%</div></div>
                <div class="card"><h3>Alertas Altas</h3><div class="value" style="color: var(--warning-color);">${alertHigh}</div><div class="card-description">40% a 100%</div></div>
                <div class="card"><h3>Alertas Bajas</h3><div class="value" style="color: var(--warning-color);">${alertLow}</div><div class="card-description">-100% a -40%</div></div>
                <div class="card"><h3>Sobre Promedio</h3><div class="value" style="color: var(--success-color);">${above}</div><div class="card-description">0% a 40%</div></div>
                <div class="card"><h3>Bajo Promedio</h3><div class="value" style="color: var(--danger-color);">${below}</div><div class="card-description">-40% a 0%</div></div>
                <div class="card"><h3>Reinicio Cicl.</h3><div class="value" style="color: var(--cyclometer-reset-color);">${cyclometerReset}</div><div class="card-description">Medidor reiniciado</div></div>
                <div class="card"><h3>Nuevo Medidor</h3><div class="value" style="color: var(--possible-new-color);">${newMeter}</div><div class="card-description">Cambio/Cuenta Nueva</div></div>
                <div class="card"><h3>Errores Datos</h3><div class="value" style="color: var(--danger-color);">${error}</div><div class="card-description">Inválidos</div></div>
                <div class="card"><h3>Consumo Cero</h3><div class="value" style="color: #7f8c8d;">${zero}</div><div class="card-description">Lectura 0 o estática</div></div>
                <div class="card"><h3>Sin Lecturas</h3><div class="value" style="color: #95a5a6;">${na}</div><div class="card-description">Todos N/A</div></div>
            `;
            document.getElementById('summaryCards').innerHTML = cardsHTML;
        }
        
        function generateCharts() {
            currentCharts.forEach(chart => chart.destroy());
            currentCharts = [];
            
            const chartableData = filteredData.filter(item => item.percentageVsAvg !== undefined);
            if (chartableData.length === 0) {
                ['chartDistribution', 'chartTopAbove', 'chartTopBelow'].forEach(id => {
                    const canvas = document.getElementById(id);
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    }
                });
            } else {
                const clients = chartableData.map(item => item.cliente);
                const percentages = chartableData.map(item => item.percentageVsAvg);
                
                currentCharts.push(new Chart(document.getElementById('chartDistribution').getContext('2d'), {
                    type: 'bar',
                    data: { labels: clients, datasets: [{ label: '% Variación vs Promedio', data: percentages, backgroundColor: percentages.map(p => { if (p >= 700) return 'rgba(192, 57, 43, 0.7)'; if (p >= 100 || p <= -100) return 'rgba(142, 68, 173, 0.7)'; if (p >= 40 || p <= -40) return 'rgba(243, 156, 18, 0.7)'; if (p > 0) return 'rgba(39, 174, 96, 0.7)'; return 'rgba(52, 152, 219, 0.7)'; }) }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: '% Variación vs Promedio' } }, x: { display: false } } }
                }));
                
                const sortedAbove = [...chartableData].filter(item => item.percentageVsAvg >= 0).sort((a, b) => (b.percentageVsAvg || 0) - (a.percentageVsAvg || 0)).slice(0, 5);
                currentCharts.push(new Chart(document.getElementById('chartTopAbove').getContext('2d'), {
                    type: 'bar',
                    data: { labels: sortedAbove.map(item => item.cliente), datasets: [{ label: '% Sobre Promedio', data: sortedAbove.map(item => item.percentageVsAvg || 0), backgroundColor: sortedAbove.map(item => item.status === 'posible-error-alto-consumo' ? 'rgba(192, 57, 43, 0.7)' : item.status.startsWith('urgent') ? 'rgba(142, 68, 173, 0.7)' : 'rgba(243, 156, 18, 0.7)') }] },
                    options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, title: { display: true, text: '% Sobre Promedio' } } } }
                }));
                
                const sortedBelow = [...chartableData].filter(item => item.percentageVsAvg < 0).sort((a, b) => (a.percentageVsAvg || 0) - (b.percentageVsAvg || 0)).slice(0, 5);
                currentCharts.push(new Chart(document.getElementById('chartTopBelow').getContext('2d'), {
                    type: 'bar',
                    data: { labels: sortedBelow.map(item => item.cliente), datasets: [{ label: '% Bajo Promedio', data: sortedBelow.map(item => item.percentageVsAvg || 0), backgroundColor: sortedBelow.map(item => item.status.startsWith('urgent') ? 'rgba(142, 68, 173, 0.7)' : 'rgba(243, 156, 18, 0.7)') }] },
                    options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { title: { display: true, text: '% Bajo Promedio' } } } }
                }));
            }
            updateMonthlyConsumptionChart();
        }
        
        function updateMonthlyConsumptionChart() {
            const selectedClients = filteredData.filter(c => c.validValues.length > 0).slice(0, 5);
            const ctxMonthly = document.getElementById('chartMonthlyConsumption');
            
            const existingChart = currentCharts.find(chart => chart.canvas === ctxMonthly);
            if (existingChart) { existingChart.destroy(); currentCharts = currentCharts.filter(chart => chart !== existingChart); }
            if (selectedClients.length === 0) {
                 const ctx = ctxMonthly.getContext('2d');
                 ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                 return;
            }

            const labels = selectedClients[0].headers;
            const datasets = selectedClients.map(client => {
                const color = `hsl(${Math.random() * 360}, 70%, 50%)`;
                return { label: `Cliente ${client.cliente}`, data: client.values, borderColor: color, backgroundColor: color.replace(')', ', 0.2)').replace('hsl', 'hsla'), tension: 0.1, fill: true, spanGaps: true };
            });
            
            currentCharts.push(new Chart(ctxMonthly, {
                type: 'line', data: { labels, datasets },
                options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Evolución de Consumo (Primeros 5 Filtrados)' } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Consumo (kWh)' } } } }
            }));
        }
        
        function generateDetailedAnalysis() {
            let analysisHTML = '<h2 style="color: var(--primary-color); border-bottom: 2px solid var(--secondary-color); padding-bottom: 10px; margin-bottom: 20px;">Análisis Detallado por Cliente</h2>';
            
            if (filteredData.length === 0) {
                analysisHTML += '<p style="text-align: center; color: #7f8c8d; margin-top: 30px;">No hay datos que coincidan con los filtros aplicados</p>';
            } else {
                filteredData.forEach(item => {
                    let statusBadge = '', priorityBadge = '';
                    switch(item.status) {
                        case 'error': statusBadge = '<span class="badge badge-danger"><i class="fas fa-exclamation-circle"></i> Error</span>'; priorityBadge = '<span class="badge badge-danger">Prioridad Alta</span>'; break;
                        case 'posible-nuevo-medidor': statusBadge = '<span class="badge badge-posible-nuevo-medidor"><i class="fas fa-star"></i> Nuevo Medidor</span>'; priorityBadge = '<span class="badge badge-warning">Prioridad Alta</span>'; break;
                        case 'reinicio-ciclometrico': statusBadge = '<span class="badge badge-reinicio-ciclometrico"><i class="fas fa-sync-alt"></i> Reinicio Ciclométrico</span>'; priorityBadge = '<span class="badge badge-warning">Prioridad Alta</span>'; break;
                        case 'posible-error-alto-consumo': statusBadge = '<span class="badge badge-posible-error-alto-consumo"><i class="fas fa-fire"></i> Posible Error</span>'; priorityBadge = '<span class="badge badge-urgent">Prioridad Urgente</span>'; break;
                        case 'consumo-cero': statusBadge = '<span class="badge badge-consumo-cero"><i class="fas fa-exclamation-triangle"></i> Consumo Cero</span>'; priorityBadge = '<span class="badge badge-urgent">Prioridad Urgente</span>'; break;
                        case 'sin-lecturas': statusBadge = '<span class="badge badge-sin-lecturas"><i class="fas fa-question-circle"></i> Sin Lecturas</span>'; priorityBadge = '<span class="badge badge-sin-lecturas">Prioridad Alta</span>'; break;
                        case 'urgent-high': statusBadge = '<span class="badge badge-urgent"><i class="fas fa-arrow-up"></i> Urgente Alto</span>'; priorityBadge = '<span class="badge badge-urgent">Prioridad Urgente</span>'; break;
                        case 'urgent-low': statusBadge = '<span class="badge badge-urgent"><i class="fas fa-arrow-down"></i> Urgente Bajo</span>'; priorityBadge = '<span class="badge badge-urgent">Prioridad Urgente</span>'; break;
                        case 'alert-high': statusBadge = '<span class="badge badge-warning"><i class="fas fa-arrow-up"></i> Alerta Alta</span>'; priorityBadge = '<span class="badge badge-warning">Prioridad Alta</span>'; break;
                        case 'alert-low': statusBadge = '<span class="badge badge-warning"><i class="fas fa-arrow-down"></i> Alerta Baja</span>'; priorityBadge = '<span class="badge badge-warning">Prioridad Alta</span>'; break;
                        case 'above': statusBadge = '<span class="badge badge-success"><i class="fas fa-arrow-up"></i> Sobre Promedio</span>'; priorityBadge = '<span class="badge badge-info">Prioridad Normal</span>'; break;
                        case 'below': statusBadge = '<span class="badge badge-danger"><i class="fas fa-arrow-down"></i> Bajo Promedio</span>'; priorityBadge = '<span class="badge badge-info">Prioridad Normal</span>'; break;
                        default: statusBadge = '<span class="badge badge-info"><i class="fas fa-check"></i> Normal</span>'; priorityBadge = '<span class="badge badge-info">Prioridad Normal</span>';
                    }
                    const isSpecialCase = ['error', 'consumo-cero', 'sin-lecturas', 'posible-nuevo-medidor', 'reinicio-ciclometrico', 'posible-error-alto-consumo'].includes(item.status);
                    const specialCaseBgColor = item.status === 'error' ? 'rgba(231, 76, 60, 0.1)' : item.status === 'posible-nuevo-medidor' ? 'rgba(26, 188, 156, 0.1)' : item.status === 'reinicio-ciclometrico' ? 'rgba(211, 84, 0, 0.1)' : item.status === 'posible-error-alto-consumo' ? 'rgba(192, 57, 43, 0.1)' : item.status === 'consumo-cero' ? 'rgba(127, 140, 141, 0.1)' : 'rgba(149, 165, 166, 0.1)';
                    const specialCaseBorderColor = item.status === 'error' ? 'var(--danger-color)' : item.status === 'posible-nuevo-medidor' ? 'var(--possible-new-color)' : item.status === 'reinicio-ciclometrico' ? 'var(--cyclometer-reset-color)' : item.status === 'posible-error-alto-consumo' ? 'var(--possible-error-color)' : item.status === 'consumo-cero' ? 'var(--zero-color)' : 'var(--na-color)';
                    
                    analysisHTML += `
                    <div class="client-details" id="client-${item.cliente}" style="${item.priority === 'urgent' ? 'border-left: 5px solid var(--urgent-color);' : item.priority === 'high' ? 'border-left: 5px solid var(--warning-color);' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;"><h3 style="margin: 0;"><i class="fas fa-user"></i> Cliente: ${item.cliente}</h3><div style="display: flex; gap: 10px;">${statusBadge}${priorityBadge}</div></div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px;"><h4 style="margin-top: 0; color: var(--dark-gray);"><i class="fas fa-home"></i> Servicio</h4><div style="font-size: 1.2em; font-weight: 600; color: var(--primary-color);">${item.servicio || 'N/D'}</div></div>
                            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px;"><h4 style="margin-top: 0; color: var(--dark-gray);"><i class="fas fa-map-marker-alt"></i> Ubicación</h4><div style="font-size: 1.2em; font-weight: 600; color: var(--primary-color);">${item.ubicacion || 'N/D'}</div></div>
                            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px;"><h4 style="margin-top: 0; color: var(--dark-gray);"><i class="fas fa-layer-group"></i> Sección</h4><div style="font-size: 1.2em; font-weight: 600; color: var(--primary-color);">${item.seccion || 'N/D'}</div></div>
                            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px;"><h4 style="margin-top: 0; color: var(--dark-gray);"><i class="fas fa-user-tie"></i> Operario</h4><div style="font-size: 1.2em; font-weight: 600; color: var(--primary-color);">${item.nombreOperario || 'N/D'}</div></div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px;"><h4 style="margin-top: 0; color: var(--dark-gray);"><i class="fas fa-info-circle"></i> CODCAUSAOBS</h4><div style="font-size: 1.2em; font-weight: 600; color: var(--primary-color);">${item.codCausaObs || 'N/D'}</div></div>
                            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px;"><h4 style="margin-top: 0; color: var(--dark-gray);"><i class="fas fa-info-circle"></i> OBS_PREDIO</h4><div style="font-size: 1.2em; font-weight: 600; color: var(--primary-color);">${item.obsPredio || 'N/D'}</div></div>
                            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px;"><h4 style="margin-top: 0; color: var(--dark-gray);"><i class="fas fa-info-circle"></i> OBS_TEXTO</h4><div style="font-size: 1.2em; font-weight: 600; color: var(--primary-color);">${item.obsTexto || 'N/D'}</div></div>
                        </div>
                        ${!isSpecialCase ? `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;"><div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px;"><h4 style="margin-top: 0; color: var(--dark-gray);"><i class="fas fa-calculator"></i> Promedio Variación</h4><div style="font-size: 1.5em; font-weight: 600; color: var(--primary-color);">${item.avgDifference !== undefined ? item.avgDifference.toFixed(2) : 'N/A'} kWh</div><div style="font-size: 0.9em; color: #7f8c8d;">Histórico mensual</div></div><div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px;"><h4 style="margin-top: 0; color: var(--dark-gray);"><i class="fas fa-bolt"></i> Última Variación</h4><div style="font-size: 1.5em; font-weight: 600; color: ${item.lastDiff >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">${item.lastDiff !== undefined ? (item.lastDiff >= 0 ? '+' : '') + item.lastDiff.toFixed(2) : 'N/A'} kWh</div><div style="font-size: 0.9em; color: #7f8c8d;">Últimos períodos</div></div><div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px;"><h4 style="margin-top: 0; color: var(--dark-gray);"><i class="fas fa-balance-scale"></i> Diferencia</h4><div style="font-size: 1.5em; font-weight: 600; color: ${item.diffVsAvg >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">${item.diffVsAvg !== undefined ? (item.diffVsAvg >= 0 ? '+' : '') + item.diffVsAvg.toFixed(2) : 'N/A'} kWh</div><div style="font-size: 0.9em; color: #7f8c8d;">vs promedio</div></div><div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px;"><h4 style="margin-top: 0; color: var(--dark-gray);"><i class="fas fa-percentage"></i> % Variación</h4><div style="font-size: 1.5em; font-weight: 600; color: ${item.percentageVsAvg >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">${item.percentageVsAvg !== undefined ? (item.percentageVsAvg === Infinity ? '∞' : (item.percentageVsAvg >= 0 ? '+' : '') + item.percentageVsAvg.toFixed(2) + '%') : 'N/A'}</div><div style="font-size: 0.9em; color: #7f8c8d;">vs promedio</div></div></div>` : ''}
                        <h4 style="color: var(--dark-gray); margin-bottom: 15px;"><i class="fas fa-history"></i> Evolución por Período</h4><div style="overflow-x: auto; margin-bottom: 20px;"><table style="width: 100%;"><thead><tr>${item.headers.map(h => `<th style="text-align: center; background-color: var(--primary-color); color: white; padding: 10px;">${h}</th>`).join('')}</tr></thead><tbody><tr>${item.values.map(v => `<td style="text-align: center; padding: 10px; ${v === 'N/A' ? 'background-color: rgba(149, 165, 166, 0.2);' : v === 0 ? 'background-color: rgba(127, 140, 141, 0.2);' : ''}">${v === 0 ? '0' : v}</td>`).join('')}</tr></tbody></table></div>
                        ${item.monthlyDetails && item.monthlyDetails.length > 50 ? `<h4 style="color: var(--dark-gray); margin-bottom: 15px;"><i class="fas fa-chart-line"></i> Variaciones por Período</h4>${item.monthlyDetails}` : ''}
                        ${isSpecialCase ? `<div style="margin-top: 20px; padding: 15px; background-color: ${specialCaseBgColor}; border-left: 4px solid ${specialCaseBorderColor};"><h4 style="margin-top: 0; color: ${specialCaseBorderColor};"><i class="fas ${item.status === 'error' ? 'fa-exclamation-triangle' : 'fa-question-circle'}"></i> ${item.validationMessage}</h4><p style="margin-bottom: 0;">${item.errorDetails ? `<small>Detalles: ${item.errorDetails}</small>` : ''}</p></div>` : ''}
                    </div>`;
                });
            }
            document.getElementById('detailedAnalysis').innerHTML = analysisHTML;
        }
        
        function showClientDetails(clientId) {
            openTab(null, 'tabAnalysis');
            setTimeout(() => {
                const element = document.getElementById(`client-${clientId}`);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    element.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
                    setTimeout(() => { element.style.backgroundColor = ''; }, 2000);
                }
            }, 100);
        }
        
        function applyFilters() {
            const filters = {
                status: document.getElementById('filterStatus').value,
                client: document.getElementById('filterClient').value.toLowerCase(),
                servicio: document.getElementById('filterServicio').value,
                ubicacion: document.getElementById('filterUbicacion').value,
                seccion: document.getElementById('filterSeccion').value,
                intentos: document.getElementById('filterIntentos').value,
                operario: document.getElementById('filterOperario').value,
                estadoOSB: document.getElementById('filterEstadoOSB').value,
                codCausaObs: document.getElementById('filterCodCausaObs').value,
                obsPredio: document.getElementById('filterObsPredio').value,
                obsTexto: document.getElementById('filterObsTexto').value,
            };
            
            filteredData = analysisData.filter(item => 
                (filters.status === 'all' || item.status === filters.status) &&
                (!filters.client || item.cliente.toLowerCase().includes(filters.client)) &&
                (filters.servicio === 'all' || item.servicio === filters.servicio) &&
                (filters.ubicacion === 'all' || item.ubicacion === filters.ubicacion) &&
                (filters.seccion === 'all' || item.seccion === filters.seccion) &&
                (filters.intentos === 'all' || item.intentos.toString() === filters.intentos) &&
                (filters.operario === 'all' || item.nombreOperario === filters.operario) &&
                (filters.estadoOSB === 'all' || item.estadoOSB === filters.estadoOSB) &&
                (filters.codCausaObs === 'all' || item.codCausaObs === filters.codCausaObs) &&
                (filters.obsPredio === 'all' || item.obsPredio === filters.obsPredio) &&
                (filters.obsTexto === 'all' || item.obsTexto === filters.obsTexto)
            );

            // --- CASCADING FILTERS LOGIC ---
            // On first load, pass all data. On subsequent filters, pass the already filtered data.
            updateDynamicFilterOptions(filteredData.length > 0 ? filteredData : analysisData);
            
            let above = 0, below = 0, alertH = 0, alertL = 0, urgentH = 0, urgentL = 0, err = 0, newMeter = 0, zero = 0, na = 0, cyclometerReset = 0, possibleError = 0;
            filteredData.forEach(item => {
                switch(item.status) {
                    case 'posible-error-alto-consumo': possibleError++; break;
                    case 'urgent-high': urgentH++; break;
                    case 'alert-high': alertH++; break;
                    case 'above': above++; break;
                    case 'urgent-low': urgentL++; break;
                    case 'alert-low': alertL++; break;
                    case 'below': below++; break;
                    case 'error': err++; break;
                    case 'posible-nuevo-medidor': newMeter++; break;
                    case 'reinicio-ciclometrico': cyclometerReset++; break;
                    case 'consumo-cero': zero++; break;
                    case 'sin-lecturas': na++; break;
                }
            });
            
            updateSummaryCards(filteredData.length, above, below, alertH, alertL, urgentH, urgentL, err, newMeter, zero, na, cyclometerReset, possibleError);
            updateActiveFilters();
            updateTable();
            generateDetailedAnalysis();
            generateCharts();
        }

        function showAllZeroAndNA() {
            removeFilter('all');
            filteredData = analysisData.filter(item => ['consumo-cero', 'sin-lecturas', 'error', 'posible-nuevo-medidor', 'reinicio-ciclometrico'].includes(item.status));
            
            let err = 0, newMeter = 0, zero = 0, na = 0, cyclometerReset = 0;
            filteredData.forEach(item => {
                if (item.status === 'error') err++;
                if (item.status === 'posible-nuevo-medidor') newMeter++;
                if (item.status === 'reinicio-ciclometrico') cyclometerReset++;
                if (item.status === 'consumo-cero') zero++;
                if (item.status === 'sin-lecturas') na++;
            });
            
            updateSummaryCards(filteredData.length, 0, 0, 0, 0, 0, 0, err, newMeter, zero, na, cyclometerReset, 0);
            updateActiveFilters(true);
            updateTable();
            generateDetailedAnalysis();
            generateCharts();
        }
        
        function updateActiveFilters(isSpecialFilter = false) {
            const container = document.getElementById('activeFilters');
            let html = '';
            if (isSpecialFilter) {
                html += `<div class="filter-tag">Casos Especiales<button onclick="removeFilter('all')">×</button></div>`;
            } else {
                const addTag = (id, label, type) => {
                    const el = document.getElementById(id);
                    const value = el.value;
                    if (value && value !== 'all') {
                        const text = el.tagName === 'SELECT' ? el.options[el.selectedIndex].text : value;
                        html += `<div class="filter-tag">${label}: ${text}<button onclick="removeFilter('${type}')">×</button></div>`;
                    }
                };
                addTag('filterStatus', 'Estado', 'status');
                addTag('filterClient', 'Cliente', 'client');
                addTag('filterServicio', 'Servicio', 'servicio');
                addTag('filterUbicacion', 'Ubicación', 'ubicacion');
                addTag('filterSeccion', 'Sección', 'seccion');
                addTag('filterIntentos', 'Intentos', 'intentos');
                addTag('filterOperario', 'Operario', 'operario');
                addTag('filterEstadoOSB', 'Estado OSB', 'estadoOSB');
                addTag('filterCodCausaObs', 'CODCAUSAOBS', 'codCausaObs');
                addTag('filterObsTexto', 'OBS_TEXTO', 'obsTexto');
            }
            container.innerHTML = html || '<div style="color: #7f8c8d; font-style: italic;">No hay filtros aplicados</div>';
        }
        
        function removeFilter(type) {
            const filterMap = {
                status: 'filterStatus', client: 'filterClient', servicio: 'filterServicio', ubicacion: 'filterUbicacion',
                seccion: 'filterSeccion', intentos: 'filterIntentos', operario: 'filterOperario', estadoOSB: 'filterEstadoOSB',
                codCausaObs: 'filterCodCausaObs', obsPredio: 'filterObsPredio', obsTexto: 'filterObsTexto'
            };
            if (type === 'all') {
                Object.values(filterMap).forEach(id => document.getElementById(id).value = id === 'filterClient' ? '' : 'all');
            } else {
                const el = document.getElementById(filterMap[type]);
                el.value = el.tagName === 'INPUT' ? '' : 'all';
            }
            applyFilters();
        }
        
        function exportToExcel() {
            const wb = XLSX.utils.book_new();

            const wsData = [['ID Cliente', 'Servicio', 'Ubicación', 'Sección', 'Intentos', 'Operario', 'Estado OSB', 'CODCAUSAOBS', 'OBS_PREDIO', 'OBS_TEXTO', 'Promedio Variación (kWh)', 'Última Variación (kWh)', 'Diferencia (kWh)', '% vs Promedio', 'Estado', 'Prioridad', 'Mensaje de Validación']];
            filteredData.forEach(item => {
                let statusText = 'Normal';
                switch(item.status) {
                    case 'error': statusText = 'Error datos'; break; case 'posible-nuevo-medidor': statusText = 'Posible Medidor/Cuenta Nueva'; break;
                    case 'reinicio-ciclometrico': statusText = 'REINICIO DE CICLOMETRICO'; break; case 'posible-error-alto-consumo': statusText = 'POSIBLE ERROR (+700%)'; break;
                    case 'consumo-cero': statusText = 'Consumo Cero'; break; case 'sin-lecturas': statusText = 'Sin Lecturas'; break;
                    case 'urgent-high': statusText = 'Urgente alto (+100%)'; break; case 'urgent-low': statusText = 'Urgente bajo (-100%)'; break;
                    case 'alert-high': statusText = 'Alerta alta (+40%)'; break; case 'alert-low': statusText = 'Alerta baja (-40%)'; break;
                    case 'above': statusText = 'Sobre promedio'; break; case 'below': statusText = 'Bajo promedio'; break;
                }
                wsData.push([item.cliente, item.servicio, item.ubicacion, item.seccion, item.intentos, item.nombreOperario, item.estadoOSB, item.codCausaObs, item.obsPredio, item.obsTexto, item.avgDifference !== undefined ? item.avgDifference.toFixed(2) : 'N/A', item.lastDiff !== undefined ? item.lastDiff.toFixed(2) : 'N/A', item.diffVsAvg !== undefined ? item.diffVsAvg.toFixed(2) : 'N/A', item.percentageVsAvg !== undefined ? item.percentageVsAvg.toFixed(2) : 'N/A', statusText, item.priority === 'urgent' ? 'Urgente' : item.priority === 'high' ? 'Alta' : 'Normal', item.validationMessage]);
            });
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            ws['!cols'] = Array(wsData[0].length).fill({wch: 20});
            XLSX.utils.book_append_sheet(wb, ws, "Datos Detallados");

            let counts = { above: 0, below: 0, alertH: 0, alertL: 0, urgentH: 0, urgentL: 0, err: 0, newMeter: 0, zero: 0, na: 0, cyclometerReset: 0, possibleError: 0 };
            filteredData.forEach(item => {
                switch(item.status) {
                    case 'posible-error-alto-consumo': counts.possibleError++; break; case 'urgent-high': counts.urgentH++; break;
                    case 'alert-high': counts.alertH++; break; case 'above': counts.above++; break;
                    case 'urgent-low': counts.urgentL++; break; case 'alert-low': counts.alertL++; break;
                    case 'below': counts.below++; break; case 'error': counts.err++; break;
                    case 'posible-nuevo-medidor': counts.newMeter++; break; case 'reinicio-ciclometrico': counts.cyclometerReset++; break;
                    case 'consumo-cero': counts.zero++; break; case 'sin-lecturas': counts.na++; break;
                }
            });
            
            const summaryData = [
                ["Resumen de Estado de Clientes"], [],
                ["Categoría de Estado", "Cantidad", "Nivel de Prioridad", "Recomendación de Acción"],
                ["Posible Error (+700%)", counts.possibleError, "Urgente", "Revisión inmediata. Potencial fuga, medidor averiado o error de lectura."],
                ["Urgente Alto (100%-700%)", counts.urgentH, "Urgente", "Investigar de inmediato. Posible cambio de hábitos, fuga o error."],
                ["Urgente Bajo (<-100%)", counts.urgentL, "Urgente", "Investigar de inmediato. Posible medidor detenido o lectura incorrecta."],
                ["Reinicio de Ciclométrico", counts.cyclometerReset, "Alta", "Verificar si el cambio es legítimo y ajustar histórico si es necesario."],
                ["Posible Nuevo Medidor", counts.newMeter, "Alta", "Confirmar si hubo cambio de medidor o es una cuenta nueva. Validar lectura."],
                ["Alerta Alta (40%-100%)", counts.alertH, "Alta", "Revisar. Podría ser un aumento de consumo estacional o el inicio de un problema."],
                ["Alerta Baja (-100% a -40%)", counts.alertL, "Alta", "Revisar. Podría indicar una reducción de consumo o un medidor lento."],
                ["Sobre Promedio (0-40%)", counts.above, "Normal", "Monitorear en el próximo ciclo. Generalmente dentro de la variación esperada."],
                ["Bajo Promedio (-40% a 0%)", counts.below, "Normal", "Monitorear en el próximo ciclo. Generalmente dentro de la variación esperada."],
                ["Consumo Cero", counts.zero, "Urgente", "Verificar si la propiedad está desocupada o si el medidor está detenido."],
                ["Errores en Datos", counts.err, "Alta", "Corregir los datos de origen. Las lecturas no son secuenciales."],
                ["Sin Lecturas", counts.na, "Alta", "Revisar por qué no hay datos para estos clientes."]
            ];
            
            const totalCount = Object.values(counts).reduce((sum, val) => sum + val, 0);
            summaryData.push([]);
            summaryData.push(["TOTAL DE CLIENTES EN CATEGORÍAS", totalCount]);
            summaryData.push(["TOTAL DE CLIENTES FILTRADOS", filteredData.length]);
            
            const analysisText = generateReportAnalysis(counts, filteredData.length);
            summaryData.push([]);
            summaryData.push(["Análisis Cualitativo del Reporte"]);
            summaryData.push([analysisText]);

            const ws_summary = XLSX.utils.aoa_to_sheet(summaryData);
            ws_summary['!cols'] = [{wch: 30}, {wch: 10}, {wch: 20}, {wch: 70}];
             ws_summary['!merges'] = [
                { s: { r: 0, c: 0 }, e: { r: 0, c: 3 } },
                { s: { r: 19, c: 0 }, e: { r: 19, c: 3 } },
                { s: { r: 20, c: 0 }, e: { r: 20, c: 3 } }
            ];

            XLSX.utils.book_append_sheet(wb, ws_summary, "Resumen y Análisis");
            XLSX.writeFile(wb, `analisis_consumo_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        function generateReportAnalysis(counts, total) {
            if (total === 0) return "No hay datos filtrados para analizar.";
            let text = `ANÁLISIS GENERAL DEL REPORTE (Total de ${total} clientes filtrados):\n\n`;
            let criticalPoints = "";
            if (counts.possibleError > 0) criticalPoints += `- ${counts.possibleError} caso(s) de 'Posible Error' (+700%): Requieren inspección inmediata. Podrían indicar fugas severas, medidores cruzados o errores de lectura graves.\n`;
            if (counts.urgentH > 0) criticalPoints += `- ${counts.urgentH} caso(s) 'Urgente Alto' (+100%): Necesitan investigación prioritaria para descartar problemas significativos.\n`;
            if (counts.urgentL > 0) criticalPoints += `- ${counts.urgentL} caso(s) 'Urgente Bajo' (<-100%): Indican una alta probabilidad de medidor detenido o lectura incorrecta. Revisar urgentemente.\n`;
            if (counts.zero > 0) criticalPoints += `- ${counts.zero} caso(s) con 'Consumo Cero': Confirmar si la propiedad está desocupada o si el medidor no está registrando consumo.\n`;
            if(criticalPoints) {
                text += "**PUNTOS CRÍTICOS (ACCIÓN INMEDIATA):**\n" + criticalPoints;
            } else {
                text += "**PUNTOS CRÍTICOS (ACCIÓN INMEDIATA):**\n- No se detectaron anomalías de prioridad 'Urgente'.\n";
            }
            let highPriorityPoints = "";
            if (counts.cyclometerReset > 0) highPriorityPoints += `- ${counts.cyclometerReset} caso(s) de 'Reinicio de Ciclométrico': Validar para asegurar el registro correcto del "paso por cero".\n`;
            if (counts.newMeter > 0) highPriorityPoints += `- ${counts.newMeter} caso(s) de 'Posible Nuevo Medidor': Confirmar para ajustar promedios históricos.\n`;
            if (counts.alertH > 0 || counts.alertL > 0) highPriorityPoints += `- ${counts.alertH + counts.alertL} caso(s) en 'Alerta': Monitorear de cerca en el próximo ciclo.\n`;
            if (highPriorityPoints) {
                text += "\n**OBSERVACIONES DE PRIORIDAD ALTA:**\n" + highPriorityPoints;
            }
            const normalCases = counts.above + counts.below;
            const percentageNormal = total > 0 ? ((normalCases / total) * 100).toFixed(1) : 0;
            text += `\n**COMPORTAMIENTO GENERAL:**\n- ${normalCases} de ${total} clientes (${percentageNormal}%) muestran variaciones dentro de un rango normal.\n`;
            let dataQuality = "";
            if (counts.err > 0) dataQuality += `- Se encontraron ${counts.err} cliente(s) con 'Errores en Datos'. Corregir en origen.\n`;
            if (counts.na > 0) dataQuality += `- Hay ${counts.na} cliente(s) 'Sin Lecturas', impidiendo su análisis.\n`;
            if(dataQuality) {
                text += "\n**CALIDAD DE DATOS:**\n" + dataQuality;
            } else {
                 text += "\n**CALIDAD DE DATOS:**\n- La calidad de los datos es buena, sin errores de secuencia ni registros sin lectura.\n";
            }
            return text;
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm' });

            doc.setFontSize(16); doc.setTextColor(44, 62, 80);
            doc.text('Reporte de Análisis de Consumo - Resumen Ejecutivo', 148, 15, { align: 'center' });
            doc.setFontSize(10); doc.setTextColor(127, 140, 141);
            doc.text(`Generado el: ${new Date().toLocaleDateString()} | Clientes Filtrados: ${filteredData.length}`, 148, 22, { align: 'center' });
            
            let counts = { above: 0, below: 0, alertH: 0, alertL: 0, urgentH: 0, urgentL: 0, err: 0, newMeter: 0, zero: 0, na: 0, cyclometerReset: 0, possibleError: 0 };
             filteredData.forEach(item => {
                switch(item.status) {
                    case 'posible-error-alto-consumo': counts.possibleError++; break; case 'urgent-high': counts.urgentH++; break;
                    case 'alert-high': counts.alertH++; break; case 'above': counts.above++; break;
                    case 'urgent-low': counts.urgentL++; break; case 'alert-low': counts.alertL++; break;
                    case 'below': counts.below++; break; case 'error': counts.err++; break;
                    case 'posible-nuevo-medidor': counts.newMeter++; break; case 'reinicio-ciclometrico': counts.cyclometerReset++; break;
                    case 'consumo-cero': counts.zero++; break; case 'sin-lecturas': counts.na++; break;
                }
            });

            const summaryHeaders = [["Categoría de Estado", "Cantidad", "Prioridad"]];
            const summaryBody = [
                ["Posible Error (+700%)", counts.possibleError, "Urgente"],
                ["Urgente Alto (100%-700%)", counts.urgentH, "Urgente"],
                ["Urgente Bajo (<-100%)", counts.urgentL, "Urgente"],
                ["Reinicio de Ciclométrico", counts.cyclometerReset, "Alta"],
                ["Posible Nuevo Medidor", counts.newMeter, "Alta"],
                ["Alerta Alta (40%-100%)", counts.alertH, "Alta"],
                ["Alerta Baja (-100% a -40%)", counts.alertL, "Alta"],
                ["Sobre Promedio (0-40%)", counts.above, "Normal"],
                ["Bajo Promedio (-40% a 0%)", counts.below, "Normal"],
                ["Consumo Cero", counts.zero, "Urgente"],
                ["Errores en Datos", counts.err, "Alta"],
                ["Sin Lecturas", counts.na, "Alta"]
            ];

            doc.autoTable({
                startY: 30, head: summaryHeaders, body: summaryBody, theme: 'grid',
                headStyles: { fillColor: [44, 62, 80], textColor: 255 },
                foot: [[ "Total Clientes", filteredData.length, ""]], footStyles: {fontStyle: 'bold', fillColor: [236, 240, 241]},
                columnStyles: { 0: { cellWidth: 50 }, 1: { cellWidth: 20, halign: 'center' }, 2: { cellWidth: 30, halign: 'center'} },
                margin: { left: 14 }
            });

            let finalY = doc.autoTable.previous.finalY;
            doc.setFontSize(12); doc.setTextColor(44, 62, 80);
            doc.text('Análisis Cualitativo del Reporte', 14, finalY + 15);
            doc.setFontSize(9); doc.setTextColor(80, 80, 80);
            const analysisText = generateReportAnalysis(counts, filteredData.length).replace(/\*\*/g, '');
            const lines = doc.splitTextToSize(analysisText, 270);
            doc.text(lines, 14, finalY + 22);

            doc.addPage();
            doc.setFontSize(16); doc.setTextColor(44, 62, 80);
            doc.text('Datos Detallados de Clientes', 148, 15, { align: 'center' });
            
            const tableData = filteredData.map(item => {
                let statusText = 'Normal';
                switch(item.status) {
                    case 'error': statusText = 'Error'; break; case 'posible-nuevo-medidor': statusText = 'Nuevo Medidor'; break;
                    case 'reinicio-ciclometrico': statusText = 'Reinicio Cicl.'; break; case 'posible-error-alto-consumo': statusText = 'Error >700%'; break;
                    case 'consumo-cero': statusText = 'Cero'; break; case 'sin-lecturas': statusText = 'Sin Lect.'; break;
                    case 'urgent-high': statusText = 'Urg. Alto'; break; case 'urgent-low': statusText = 'Urg. Bajo'; break;
                    case 'alert-high': statusText = 'Alerta Alta'; break; case 'alert-low': statusText = 'Alerta Baja'; break;
                    case 'above': statusText = 'Sobre'; break; case 'below': statusText = 'Bajo'; break;
                }
                const avgDiff = item.avgDifference !== undefined ? item.avgDifference.toFixed(2) : 'N/A';
                const lastDiff = item.lastDiff !== undefined ? (item.lastDiff >= 0 ? '+' : '') + item.lastDiff.toFixed(2) : 'N/A';
                const percent = item.percentageVsAvg !== undefined ? (item.percentageVsAvg === Infinity ? '∞' : (item.percentageVsAvg >= 0 ? '+' : '') + item.percentageVsAvg.toFixed(2) + '%') : 'N/A';
                return [item.cliente, item.seccion, statusText, item.priority, avgDiff, lastDiff, percent, item.validationMessage];
            });
            
            doc.autoTable({
                startY: 25, head: [['Cliente', 'Sección', 'Estado', 'Prioridad', 'Prom. Var.', 'Últ. Var.', '% vs Prom.', 'Mensaje']],
                body: tableData, theme: 'grid', headStyles: { fillColor: [44, 62, 80], textColor: 255 },
                styles: { overflow: 'linebreak', fontSize: 6.5, cellPadding: 1.5 },
                columnStyles: { 7: { cellWidth: 60 } }
            });

            doc.save(`reporte_consumo_${new Date().toISOString().slice(0,10)}.pdf`);
        }
        
        async function exportCharts() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'landscape', unit: 'mm' });
                doc.setFontSize(16); doc.setTextColor(44, 62, 80); doc.text('Reporte Gráfico de Análisis de Consumo', 145, 15, { align: 'center' });
                doc.setFontSize(10); doc.setTextColor(127, 140, 141); doc.text(`Generado el: ${new Date().toLocaleDateString()}`, 145, 22, { align: 'center' });
                const charts = [{ id: 'chartDistribution', title: 'Distribución de Variaciones' }, { id: 'chartTopAbove', title: 'Top 5 Mayores Variaciones' }, { id: 'chartTopBelow', title: 'Top 5 Menores Variaciones' }, { id: 'chartMonthlyConsumption', title: 'Consumo por Período' }];
                let yPos = 30;
                for (const chart of charts) {
                    const canvas = document.getElementById(chart.id); if (!canvas) continue;
                    if (yPos > 180) { doc.addPage(); yPos = 15; }
                    doc.setFontSize(12); doc.setTextColor(44, 62, 80); doc.text(chart.title, 15, yPos); yPos += 5;
                    const img = await html2canvas(canvas, { scale: 2, backgroundColor: '#ffffff', useCORS: true });
                    const imgData = img.toDataURL('image/png');
                    const imgWidth = 270; const imgHeight = (img.height * imgWidth) / img.width;
                    if (yPos + imgHeight > 200) { doc.addPage(); yPos = 15; }
                    doc.addImage(imgData, 'PNG', 15, yPos, imgWidth, imgHeight); yPos += imgHeight + 10;
                }
                doc.save(`graficos_consumo_${new Date().toISOString().slice(0,10)}.pdf`);
            } catch (error) { console.error('Error al exportar gráficos:', error); alert('Hubo un error al exportar los gráficos.'); }
        }
        
        function openTab(event, tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            const targetButton = event ? event.currentTarget : document.querySelector(`.tab-btn[onclick*="'${tabId}'"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }

            if (tabId === 'tabCharts') {
                setTimeout(() => currentCharts.forEach(chart => { if(chart) { chart.resize(); chart.update(); } }), 50);
            }
        }
        
        function clearResults() {
            document.getElementById('excelFile').value = '';
            document.getElementById('fileName').textContent = 'Ningún archivo seleccionado';
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('resultsTable').innerHTML = '';
            document.getElementById('detailedAnalysis').innerHTML = '';
            document.getElementById('summaryCards').innerHTML = '';
            removeFilter('all');
            document.getElementById('activeFilters').innerHTML = '';
            currentCharts.forEach(chart => chart.destroy());
            currentCharts = [];
        }
    </script>
</body>
</html>